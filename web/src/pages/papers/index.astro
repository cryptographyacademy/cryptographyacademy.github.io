---
import BaseLayout from '../../layouts/BaseLayout.astro';

const rawFiles = import.meta.glob('./*.astro', {
  as: 'raw',
  eager: true,
});

interface PaperEntry {
  slug: string;
  title: string;
  authors: string;
  year: string;
  number: string;
  crawler: string;
}

const papers: PaperEntry[] = Object.entries(rawFiles)
  .filter(([p]) => !p.endsWith('/index.astro'))
  .map(([filePath, content]: [string, string]) => {
    const slug = filePath
      .replace('./', '')
      .replace('.astro', '');

    // Extract eprint ID
    const eprintMatch = content.match(
      /eprint\.iacr\.org\/(\d{4})\/(\d+)/
    );
    const year = eprintMatch?.[1] ?? '????';
    const number = eprintMatch?.[2] ?? '?';

    // Extract title: try TITLE_HTML first (new format),
    // then <h1>
    let title = slug;
    const titleHtmlMatch = content.match(
      /const TITLE_HTML = '(.+?)';/
    );
    if (titleHtmlMatch) {
      title = titleHtmlMatch[1]
        .replace(/\\'/g, "'")
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>');
    } else {
      const h1Match = content.match(
        /<h1[^>]*>\s*(.+?)\s*<\/h1>/s
      );
      if (h1Match) {
        title = h1Match[1]
          .replace(/<[^>]+>/g, '')
          .replace(/\s+/g, ' ')
          .trim();
      }
    }

    // Extract authors: try AUTHORS_HTML (new), then
    // first gray-400 p
    let authors = '';
    const authorsHtmlMatch = content.match(
      /const AUTHORS_HTML = '(.+?)';/
    );
    if (authorsHtmlMatch) {
      authors = authorsHtmlMatch[1]
        .replace(/\\'/g, "'")
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>');
    } else {
      const authorsMatch = content.match(
        /<p class="text-gray-400 mb-2">\s*(.+?)\s*<\/p>/s
      );
      if (authorsMatch) {
        authors = authorsMatch[1]
          .replace(/<[^>]+>/g, '')
          .replace(/\s+/g, ' ')
          .trim();
      }
    }

    // Truncate long author lists
    if (authors.length > 80) {
      const parts = authors.split(',');
      if (parts.length > 3) {
        authors = parts.slice(0, 3).join(',') + ' et al.';
      }
    }

    // Extract crawler
    const crawlerMatch = content.match(
      /const CRAWLER = '(.+?)';/
    );
    const crawler = crawlerMatch?.[1] ?? '';

    return { slug, title, authors, year, number, crawler };
  });

// Sort by year descending, then by eprint number descending
papers.sort((a, b) => {
  const yearDiff = parseInt(b.year) - parseInt(a.year);
  if (yearDiff !== 0) return yearDiff;
  return parseInt(b.number) - parseInt(a.number);
});

const totalCount = papers.length;
---

<BaseLayout title="Paper Analyses">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-4xl font-bold mb-4">Paper Analyses</h1>
    <p class="text-xl text-gray-300 mb-3">
      In-depth breakdowns of cryptographic papers with formal
      definitions, proof reconstructions, and implementations.
    </p>
    <p class="text-gray-400 mb-8">
      Each paper page includes formal definitions extracted and
      explained, step-by-step proof reconstructions, code
      implementations in Lean 4, and cross-references to related
      work.
    </p>

    <div class="border border-gray-700 rounded-lg p-5 mb-8
      text-sm text-gray-400 leading-relaxed">
      <p class="font-semibold text-gray-300 mb-2">Our Vision</p>
      <p class="mb-2">
        cryptography.academy is an open knowledge base that links
        definitions to definitions, formulas to formulas, and proofs
        to the precise results they depend on &mdash; across the
        entire cryptographic literature. Formalizations are
        progressively machine-checked in Lean 4. Read the full
        <a
          href="https://github.com/BaDaaS/cryptographyacademy.github.io/blob/main/VISION.md"
          class="text-blue-400 hover:text-blue-300"
        >vision statement</a>.
      </p>
      <p>
        This project is and will always be <strong
          class="text-gray-300">free</strong>. No profit is made, no
        knowledge will ever be sold, and there will never be a
        paywall. The entire
        <a
          href="https://github.com/BaDaaS/cryptographyacademy.github.io"
          class="text-blue-400 hover:text-blue-300"
        >source code</a> is publicly available.
      </p>
    </div>

    <div class="border border-gray-700 rounded-lg p-5 mb-8
      text-sm text-gray-400 leading-relaxed">
      <p class="font-semibold text-gray-300 mb-2">
        Attribution &amp; Copyright Notice
      </p>
      <p class="mb-2">
        The paper content reproduced on this site belongs entirely to
        the original authors. Nothing is claimed as original work by
        BaDaaS or any contributor. Each page reproduces the paper for
        educational and academic study purposes, augmented with formal
        definitions in Lean 4 and explanatory annotations. We act in
        good faith to make verified knowledge freely accessible to
        everyone on the Internet.
      </p>
      <p>
        We respect intellectual property and welcome any feedback.
        Always cite the original publications. Canonical sources are
        linked at the top of every paper page. If you are an author
        and would like your paper removed or amended, please
        <a
          href="https://github.com/BaDaaS/cryptographyacademy.github.io/issues"
          class="text-blue-400 hover:text-blue-300"
        >open an issue</a>. We will never add a paywall or charge
        for any content.
      </p>
    </div>

    <h2 class="text-2xl font-bold mb-6">
      Papers ({totalCount})
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {papers.map((paper) => (
        <a
          href={`/papers/${paper.slug}`}
          class="bg-gray-800 p-4 rounded-lg hover:bg-gray-750
            block"
        >
          <h3 class="text-base font-semibold mb-1 line-clamp-2"
            set:html={paper.title} />
          <p class="text-xs text-gray-500 mb-2 line-clamp-1">
            {paper.authors}
          </p>
          <div class="flex items-center gap-2 text-xs">
            <span class="text-blue-400">
              eprint {paper.year}/{paper.number}
            </span>
            {paper.crawler && (
              <span class="text-gray-600">
                {paper.crawler}
              </span>
            )}
          </div>
        </a>
      ))}
    </div>
  </div>
</BaseLayout>
